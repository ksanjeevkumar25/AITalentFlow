using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using LoginApp.Data;
using LoginApp.Models;
using System.Collections.Generic;
using System.Linq;
using System.IO;

namespace LoginApp.Controllers
{
    [Authorize]
    public class ProfileController : Controller
    {
        private readonly SqlDataAccess _dataAccess = new SqlDataAccess();

        [HttpGet]
        public IActionResult Index()
        {
            // Get all skills from the database
            var skills = _dataAccess.GetSkills();
            return View(skills);
        }

        [HttpGet]
        public IActionResult SkillView()
        {
            // Get all skills from the Skill table (singular)
            var skills = _dataAccess.GetSkills();
            // Get existing employee skills for EmployeeID 101
            var existingEmployeeSkills = _dataAccess.GetEmployeeSkills(101);
            var viewModel = new SkillViewViewModel
            {
                Skills = skills,
                ExistingEmployeeSkills = existingEmployeeSkills
            };
            return View(viewModel);
        }

        [HttpPost]
        public IActionResult RateSkill(int skillId, int skillLevel, int yearsOfExperience, DateTime lastWorkedDate)
        {
            try
            {
                // Check if employee skill already exists
                var existingEmployeeSkills = _dataAccess.GetEmployeeSkills(101);
                var existingEmployeeSkill = existingEmployeeSkills.FirstOrDefault(es => es.SkillID == skillId);
                if (existingEmployeeSkill != null)
                {
                    // Update existing record
                    existingEmployeeSkill.EmployeeRatedSkillLevel = skillLevel;
                    existingEmployeeSkill.YearsOfExperience = yearsOfExperience;
                    existingEmployeeSkill.EmployeeLastWorkedOnThisSkill = lastWorkedDate;
                    existingEmployeeSkill.EmployeeSkillModifiedDate = DateTime.Today;
                    _dataAccess.UpdateEmployeeSkill(existingEmployeeSkill);
                }
                else
                {
                    // Create new record
                    var employeeSkill = new EmployeeSkills
                    {
                        EmployeeID = 101,
                        SkillID = skillId,
                        EmployeeRatedSkillLevel = skillLevel,
                        YearsOfExperience = yearsOfExperience,
                        EmployeeLastWorkedOnThisSkill = lastWorkedDate,
                        EmployeeSkillModifiedDate = DateTime.Today,
                        SupervisorRatedSkillLevel = null,
                        SupervisorRatingUpdatedOn = null,
                        AIEvaluatedScore = null,
                        AIEvaluationDate = null,
                        AIEvaluationRemarks = null
                    };
                    _dataAccess.InsertEmployeeSkill(employeeSkill);
                }
                return Json(new { success = true, message = "Skill rating saved successfully!" });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error saving skill rating: " + ex.Message });
            }
        }

        [HttpPost]
        public async Task<IActionResult> UploadResume(IFormFile resume)
        {
            if (resume == null || resume.Length == 0)
            {
                ModelState.AddModelError("Resume", "Please select a file.");
                return RedirectToAction("Index");
            }
            var allowedExtensions = new[] { ".pdf", ".doc", ".docx" };
            var extension = Path.GetExtension(resume.FileName).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                ModelState.AddModelError("Resume", "Only PDF and DOC/DOCX files are allowed.");
                return RedirectToAction("Index");
            }
            var uploads = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "resumes");
            if (!Directory.Exists(uploads))
                Directory.CreateDirectory(uploads);
            var filePath = Path.Combine(uploads, User.Identity?.Name + extension);
            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                await resume.CopyToAsync(stream);
            }
            ViewBag.Message = "Resume uploaded successfully!";
            return RedirectToAction("Index");
        }
    }

    public class SkillViewViewModel
    {
        public List<Skill> Skills { get; set; } = new();
        public List<EmployeeSkills> ExistingEmployeeSkills { get; set; } = new();
    }
}